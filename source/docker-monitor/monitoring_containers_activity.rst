.. Copyright (C) 2018 Wazuh, Inc.

.. _docker_containers_activity:

Monitoring containers activity
==============================

Overview
^^^^^^^^

Docker has added new features which was not exist before. Docker containers have a special properties and it is very interesting to monitor events which happen in this containers.

This wodle adds the capability of monitoring events on Docker containers. Events as starting, stopping or pausing a container are catched if this wodle is enabled.

Wodle requirements
^^^^^^^^^^^^^^^^^^

Dependencies
------------

- Python >= 2.7
- Pip
- docker library for Python

Part of the integration has been implemented in `Python <https://www.python.org/>`_, so we will need to have Python installed with a version 2.7 or higher. 

The correct functioning of the integration implemented in Python requires the presence of certain libraries as `docker library <https://pypi.org/project/docker/>`_.

.. note::

        It is necessary Wauzh 3.7 or higher for use this wodle


Installing dependencies
-----------------------

Pip can be used as Python package manager to install the required module. In order to use it, we will start installing this tool.


a) CentOS/RHEL/Fedora:

.. note::

        It may be necessary to enable the EPEL repository

.. code-block:: console

    # yum install python-pip

b) Debian/Ubuntu:

.. code-block:: console

    # apt-get update && apt-get install python-pip

c) From sources:

.. code-block:: console

    # curl -O https://bootstrap.pypa.io/get-pip.py
    # python get-pip.py

For installing ``docker`` library for Python: 

.. code-block:: console

    # pip install docker

Configuring wodle
^^^^^^^^^^^^^^^^^

It is necessary to have the option ``disabled`` with the value ``no`` in the ``ossec.conf`` and restart the Wazuh agent for using this capability.

.. code-block:: xml

    <wodle name="docker-listener">
        <interval>10m</interval>
        <attempts>5</attempts>
        <run_on_start>no</run_on_start>
        <disabled>no</disabled>
    </wodle>

Use cases
^^^^^^^^^

This wodle only needs that Docker service is running on the Docker server for monitoring container events. When you interact with containers, alerts will be generated and reported to Wazuh manager.

Below, you can see some examples of alerts caused by containers activity.

Start a Docker container
------------------------

The command ``docker start apache``, which start a container called `apache`, generates the following alert:

.. code-block:: console

    ** Alert 1538650953.46690: - docker,
    {"integration": "docker", "docker": {"status": "start", "id": "018205fa7e170e32578b8487e3b7040aad00b8accedb983bc2ad029238ca3620", "from": "httpd", "Type": "container", "Action": "start", "Actor": {"ID": "018205fa7e170e32578b8487e3b7040aad00b8accedb983bc2ad029238ca3620", "Attributes": {"image": "httpd", "name": "apache"}}, "time": 1538650953, "timeNano": 1538650953348902859}}
    integration: docker
    docker.status: start
    docker.id: 018205fa7e170e32578b8487e3b7040aad00b8accedb983bc2ad029238ca3620
    docker.from: httpd
    docker.Type: container
    docker.Action: start
    docker.Actor.ID: 018205fa7e170e32578b8487e3b7040aad00b8accedb983bc2ad029238ca3620
    docker.Actor.Attributes.image: httpd
    docker.Actor.Attributes.name: apache
    docker.time: 1538650953
    docker.timeNano: 1538650953348902912.000000

Stop a Docker container
-----------------------

This alert is generated by using the command ``docker stop apache``:

.. code-block:: console

    ** Alert 1538651422.49807: - docker,
    {"integration": "docker", "docker": {"status": "stop", "id": "018205fa7e170e32578b8487e3b7040aad00b8accedb983bc2ad029238ca3620", "from": "httpd", "Type": "container", "Action": "stop", "Actor": {"ID": "018205fa7e170e32578b8487e3b7040aad00b8accedb983bc2ad029238ca3620", "Attributes": {"image": "httpd", "name": "apache"}}, "time": 1538651422, "timeNano": 1538651422498123107}}
    integration: docker
    docker.status: stop
    docker.id: 018205fa7e170e32578b8487e3b7040aad00b8accedb983bc2ad029238ca3620
    docker.from: httpd
    docker.Type: container
    docker.Action: stop
    docker.Actor.ID: 018205fa7e170e32578b8487e3b7040aad00b8accedb983bc2ad029238ca3620
    docker.Actor.Attributes.image: httpd
    docker.Actor.Attributes.name: apache
    docker.time: 1538651422
    docker.timeNano: 1538651422498123008.000000

Pause a Docker container
------------------------

With the command ``docker pause apache``:

.. code-block:: console

    ** Alert 1538653524.61853: - docker,
    {"integration": "docker", "docker": {"status": "pause", "id": "018205fa7e170e32578b8487e3b7040aad00b8accedb983bc2ad029238ca3620", "from": "httpd", "Type": "container", "Action": "pause", "Actor": {"ID": "018205fa7e170e32578b8487e3b7040aad00b8accedb983bc2ad029238ca3620", "Attributes": {"image": "httpd", "name": "apache"}}, "time": 1538653524, "timeNano": 1538653524139788467}}
    integration: docker
    docker.status: pause
    docker.id: 018205fa7e170e32578b8487e3b7040aad00b8accedb983bc2ad029238ca3620
    docker.from: httpd
    docker.Type: container
    docker.Action: pause
    docker.Actor.ID: 018205fa7e170e32578b8487e3b7040aad00b8accedb983bc2ad029238ca3620
    docker.Actor.Attributes.image: httpd
    docker.Actor.Attributes.name: apache
    docker.time: 1538653524
    docker.timeNano: 1538653524139788544.000000

Unpause a Docker container
--------------------------

This is the alert for ``docker unpause apache`` command:

.. code-block:: console

    ** Alert 1538653526.62785: - docker,
    {"integration": "docker", "docker": {"status": "unpause", "id": "018205fa7e170e32578b8487e3b7040aad00b8accedb983bc2ad029238ca3620", "from": "httpd", "Type": "container", "Action": "unpause", "Actor": {"ID": "018205fa7e170e32578b8487e3b7040aad00b8accedb983bc2ad029238ca3620", "Attributes": {"image": "httpd", "name": "apache"}}, "time": 1538653526, "timeNano": 1538653526779912414}}
    integration: docker
    docker.status: unpause
    docker.id: 018205fa7e170e32578b8487e3b7040aad00b8accedb983bc2ad029238ca3620
    docker.from: httpd
    docker.Type: container
    docker.Action: unpause
    docker.Actor.ID: 018205fa7e170e32578b8487e3b7040aad00b8accedb983bc2ad029238ca3620
    docker.Actor.Attributes.image: httpd
    docker.Actor.Attributes.name: apache
    docker.time: 1538653526
    docker.timeNano: 1538653526779912448.000000
